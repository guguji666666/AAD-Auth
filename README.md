# Publish RDS using AAD AP (Azure AD application proxy)

# Requirements

Azure Active Directory:

>Azure AD P1/P2 License

>Global administrator role


Active Directory:

>Domain controller	* 1 (Windows server 2016+)

>RD Gateway Server * 1 (Windows server 2016+)

>RD session host + broker + licensing on a single server	* 1 (Windows server 2016+)


The instructions below apply to the scenario where :

>RD gateway	- Not published to public network yet ( doesn't have public IP )

>External url of RD gateway - you don’t have ssl cert issued from public CA, the default external url generated by AAD AP will be used

>Internal url of RD gateway	- You don’t want it to be exposed to public network , external url is different from the internal one



1. Deploy three servers first.
2. Make one server domain controller first.
3. Then join the other two servers to the domain. (do not deploy RDS infrastructure in the beginning )


# P1:Install AAD AP connector agent on RD gateway server 

Navigate to [Microsoft (msappproxy.net)](https://download.msappproxy.net/subscription/d3c8b69d-6bf7-42be-a529-3fe9c2e70c90/connector/download) and download the latest version of AAD AP connector

![image](https://user-images.githubusercontent.com/96930989/210068026-24211a12-2ae5-437a-bbdb-216fc7768174.png)


# P2:Create a new connector group for the new AAD AP connector

1. Navigate to [portal.azure.com](https://portal.azure.com/#home) and sign in with global administrator credentials
2. Navigate to Azure Active Directory > Application proxy
3. Select the server where you installed the connector 
4. Select the area which is close to you to reduce latency 

![image](https://user-images.githubusercontent.com/96930989/210068036-24ae26f7-e9ce-4690-b1c7-c59c80bf986f.png)

5. Click +Create when the settings are done

# P3:Configure RD Gateway/Web access(via app registration)

1. Navigate to [portal.azure.com](https://portal.azure.com/#home)and sign in with global administrator credentials.
2. Navigate to Azure Active Directory > Enterprise applications , click +new application

![image](https://user-images.githubusercontent.com/96930989/210073463-f534c1f8-77df-4122-b6c0-50442a57d21b.png)

3. Click + Create your own application

![image](https://user-images.githubusercontent.com/96930989/210073481-2284b3cc-3595-40e9-9ea6-b073ad03fd10.png)

Select Configure Application Proxy for secure remote access to an on-premises application

Then click create in the bottom

![image](https://user-images.githubusercontent.com/96930989/210073512-ff316a37-aadc-40da-b6cf-b9db1c6f1dd0.png)


>Internal URL - Suggest to use the internal FQDN of RD gateway server ( normally server name )

>External Url - Leave it if you want to user the default external url created by AAD AP (Note this url and we will need it later)

>Pre Authentication - Select Passthrough so that users will go directly to authenticate with RD web / RD gateway

>Connector group - Select the connector group we newly created

>Backend Application Timeout	- Select Long

>Headers (under Translate URLs in) - Must select no if the external url is different from internal one 
